<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Corp Chat - App</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --line:#e9ebf0; --muted:#6b7280; --accent:#3b82f6; }
    html,body { height:100%; }
    body { margin:0; background:var(--bg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    .app { display:grid; grid-template-columns:320px 1fr; gap:16px; padding:16px; max-width:1200px; margin:0 auto; }
    aside,main { background:var(--card); border:1px solid var(--line); border-radius:12px; padding:12px; }
    .title { font-weight:700; margin-bottom:8px; }
    .muted { color:var(--muted); font-size:12px; }
    .list { list-style:none; padding:0; margin:0; }
    .chat-btn { width:100%; text-align:left; border:1px solid var(--line); background:#fff; padding:8px 10px; border-radius:10px; cursor:pointer; }
    .chat-btn:hover { border-color:var(--accent); }
    .search input { width:100%; border:1px solid var(--line); border-radius:10px; padding:8px 10px; outline:none; }
    .header { display:flex; align-items:center; justify-content:space-between; gap:8px; padding-bottom:8px; border-bottom:1px solid var(--line); margin-bottom:8px; }
    #messages { height:60vh; overflow:auto; display:flex; flex-direction:column; gap:6px; padding-right:4px; }
    .msg { max-width:70%; padding:8px 10px; border:1px solid var(--line); border-radius:12px; background:#fff; align-self:flex-start; }
    .msg.me { align-self:flex-end; background:#eef5ff; border-color:#d8e6ff; }
    .msg .meta { font-size:11px; color:var(--muted); margin-bottom:2px; }
    .msg .text { white-space:pre-wrap; word-break:break-word; }
    form#send { display:flex; gap:8px; margin-top:8px; }
    form#send input { flex:1; border:1px solid var(--line); border-radius:10px; padding:10px 12px; outline:none; }
    form#send button { border:none; background:var(--accent); color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; }
  </style>
</head>
<body>
  <div class="app">
    <aside>
      <div class="title">–ú–æ–∏ —á–∞—Ç—ã</div>
      <ul id="chats" class="list"></ul>
      <div class="search" style="margin-top:16px">
        <div class="title">–ü–æ–∏—Å–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –∞–¥—Ä–µ—Å–∞—Ç–æ–≤ –õ–°</div>
        <input id="q" placeholder="–∏–º—è –∏–ª–∏ username" />
        <ul id="recipients" class="list" style="margin-top:8px"></ul>
      </div>
    </aside>
    <main>
      <div class="header">
        <div>
          <div id="header" class="title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
          <div id="subheader" class="muted"></div>
        </div>
        <div class="muted">SSE: –æ–Ω–ª–∞–π–Ω</div>
      </div>

      <div id="messages"></div>

      <form id="send">
        <input id="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autofocus />
        <button>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </form>
    </main>
  </div>

<script>
// === –î–æ–±–∞–≤–ª—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –≤–æ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã ===
function authFetch(input, init = {}) {
  const token = localStorage.getItem('accessToken');
  const headers = new Headers(init.headers || {});
  if (token) headers.set('Authorization', 'Bearer ' + token);
  return fetch(input, { ...init, headers });
}

// === –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ===
let currentChatId=null,currentRecipientId=null,myUser=null;
const userCache=new Map();const presenceMap={};

function escapeHtml(s){return (s||'').toString().replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
function fmtTime(ts){try{const d=new Date(ts);return new Intl.DateTimeFormat('ru-RU',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit'}).format(d);}catch{return'';}}
function badge(status){if(status==='ONLINE')return'‚óè online';if(status==='AWAY')return'‚óè away';return'‚óã offline';}
function senderLabel(m){if(m.senderDisplayName)return m.senderDisplayName;if(m.sender?.displayName)return m.sender.displayName;if(myUser&&m.senderId===myUser.id)return'–Ø';const u=userCache.get(m.senderId);return u?.displayName||u?.username||('ID '+m.senderId);}
function focusInput(){const el=document.getElementById('text');if(el)el.focus();}

// === –í—Å–µ fetch ‚Üí authFetch ===
async function fetchMe(){
  const r=await authFetch('/api/users/me');
  if(r.ok){
    myUser=await r.json();
    userCache.set(myUser.id,myUser);
  } else {
    console.warn('401 /api/users/me');
  }
}

async function loadChats() {
  const r = await authFetch('/api/chats');
  if (!r.ok) return console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–∞—Ç—ã', r.status);
  const data = await r.json();
  const ul = document.getElementById('chats');

  ul.innerHTML = (Array.isArray(data) ? data : [])
    .map(c => {
      // üîπ –µ—Å–ª–∏ —ç—Ç–æ DM ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è"
      const label = /^dm[:_]/i.test(c.name || '')
        ? '–õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è'
        : (c.name || ('–ß–∞—Ç ' + c.id));
      return `<li><button class="chat-btn" data-id="${c.id}">${escapeHtml(label)}</button></li>`;
    })
    .join('');

  ul.querySelectorAll('button').forEach(b =>
    b.onclick = () => openChat(+b.dataset.id, b.textContent)
  );
}

async function fetchMessages(chatId){
  const r = await authFetch(`/api/chats/${chatId}/messages?limit=50`);
  if (!r.ok) return [];
  const msgs = await r.json().catch(() => []);
  (Array.isArray(msgs) ? msgs : []).forEach(m=>{
    if (m.sender) userCache.set(m.sender.id, m.sender);
  });
  return Array.isArray(msgs) ? msgs : [];
}

async function openChat(id,title){
  currentChatId=id;currentRecipientId=null;
  document.getElementById('header').textContent=title;
  document.getElementById('messages').innerHTML='';
  const msgs=await fetchMessages(id);
  render(msgs);
}

async function openDm(recipientId,title){
  currentRecipientId=recipientId;
  const r=await authFetch('/api/chats/dm',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({recipientId})});
  if(r.ok){
    const chat=await r.json();
    currentChatId=chat.id;
    document.getElementById('header').textContent='–õ–°';
    document.getElementById('subheader').textContent=title;
    const msgs=await fetchMessages(chat.id);
    render(msgs);
  } else alert('–û—à–∏–±–∫–∞ DM');
}

function render(msgs){
  const box = document.getElementById('messages');
  box.innerHTML = '';                      // ‚Üê –æ—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –æ—Ç—Ä–∏—Å–æ–≤–∫–æ–π
  const frag = document.createDocumentFragment();
  (msgs || []).forEach(m => frag.appendChild(renderMsgEl(m)));
  box.appendChild(frag);
  box.scrollTop = box.scrollHeight;
}

function renderMsgEl(m){
  const div=document.createElement('div');
  div.className='msg '+((myUser&&m.senderId===myUser.id)?'me':'');
  div.innerHTML=`<div class="meta">${escapeHtml(senderLabel(m))} ¬∑ ${escapeHtml(fmtTime(m.createdAt))}</div><div class="text">${escapeHtml(m.content||'')}</div>`;
  return div;
}

document.getElementById('send').onsubmit = async (e) => {
  e.preventDefault();

  const input = document.getElementById('text');
  const text = input.value.trim();
  if (!text || !currentChatId) return;

  input.value = '';

  const body = currentRecipientId
    ? { recipientId: currentRecipientId, content: text }
    : { chatId: currentChatId, content: text };

  const url = currentRecipientId
    ? '/api/chats/messages/dm'
    : '/api/chats/messages/chat';

  try {
    const res = await authFetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });

    if (!res.ok) {
      console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å:', res.status);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
      return;
    }

    const created = await res.json().catch(() => null);

    // üîπ –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –∞–ø–¥–µ–π—Ç UI
    if (created && created.chatId === currentChatId) {
      appendMessage({
        id: created.id,
        chatId: created.chatId,
        senderId: created.senderId ?? (myUser?.id ?? 0),
        content: created.content ?? text,
        createdAt: created.createdAt ?? new Date().toISOString(),
        sender: created.sender ?? myUser ?? null,
        type: 'message',
      });
    } else {
      // üîπ fallback: –ø–µ—Ä–µ—á–∏—Ç–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –ø—É—Å—Ç–æ–π
      const msgs = await fetchMessages(currentChatId);
      render(msgs);
    }
  } catch (e) {
    console.error(e);
    alert('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
  } finally {
    input.focus();
  }
};

document.getElementById('q').oninput=async e=>{
  const q=e.target.value;
  const r=await authFetch('/api/users/search?q='+encodeURIComponent(q));
  const users=await r.json().catch(()=>[]);
  users.forEach(u=>userCache.set(u.id,u));
  const ul=document.getElementById('recipients');
  ul.innerHTML=(Array.isArray(users)?users:[]).map(u=>`<li><button class="chat-btn" data-id="${u.id}">${escapeHtml(u.displayName)} (${escapeHtml(u.username)})</button></li>`).join('');
  ul.querySelectorAll('button').forEach(b=>b.onclick=()=>openDm(+b.dataset.id,b.textContent));
};

function renderPresenceBadges(){
  if(currentRecipientId){
    const st=presenceMap[currentRecipientId]||'OFFLINE';
    document.getElementById('subheader').textContent='–°—Ç–∞—Ç—É—Å: '+badge(st);
  }
}

let es; // ‚Üê –í–ê–ñ–ù–û: –æ–±—ä—è–≤–ª—è–µ–º –¥–æ connectSSE, –≤–Ω–µ —Ñ—É–Ω–∫—Ü–∏–∏!

function connectSSE() {
  const token = localStorage.getItem('accessToken');
  const url = token
    ? `/api/events?access_token=${encodeURIComponent(token)}`
    : '/api/events';

  if (es) {                 // ‚Üê –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–∞—Ö
    try { es.close(); }     // –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –ø–æ—Ç–æ–∫
    catch {}
  }

  es = new EventSource(url);

  es.onmessage = (e) => {
    try {
      const msg = JSON.parse(e.data);
      if (msg?.type === 'message') appendMessage(msg);
      else if (msg?.type === 'presence') {
        presenceMap[msg.userId] = msg.status;
        renderPresenceBadges();
      }
    } catch {}
  };

  es.onerror = () => console.log('SSE reconnect...');
}

function appendMessage(evt){
  if(evt.chatId!==currentChatId)return;
  const el=renderMsgEl(evt);
  const box=document.getElementById('messages');
  box.appendChild(el);
  box.scrollTop=box.scrollHeight;
}

function pingPresence(){
  authFetch('/api/presence/ping',{method:'POST'}).catch(()=>{});
}

setInterval(()=>pingPresence(),30000);
let lastPing=0;
["mousemove","keydown","click"].forEach(ev=>document.addEventListener(ev,()=>{
  const now=Date.now();
  if(now-lastPing>10000){lastPing=now;pingPresence();}
}));

(async function init(){
  await fetchMe();
  await loadChats();
  connectSSE();
  focusInput();
})();
</script>
</body>
</html>