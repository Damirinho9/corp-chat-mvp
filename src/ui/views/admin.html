<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Corp Chat - Админка</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --line:#e9ebf0; --muted:#6b7280; --accent:#3b82f6; --danger:#ef4444; --ok:#10b981; }
    html,body { height:100%; }
    body { margin:0; background:var(--bg); font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .container { max-width:1200px; margin:0 auto; padding:16px; display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:12px; padding:12px; }
    .title { font-weight:700; margin-bottom:8px; }
    .muted { color:var(--muted); font-size:12px; }
    input, select { width:100%; border:1px solid var(--line); border-radius:10px; padding:8px 10px; outline:none; }
    button { border:none; background:var(--accent); color:#fff; padding:9px 12px; border-radius:10px; cursor:pointer; }
    button:hover { filter:brightness(0.95); }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { border-bottom:1px solid var(--line); text-align:left; padding:6px 6px; vertical-align:top; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .hint { font-size:11px; color:var(--muted); margin-top:-6px; margin-bottom:8px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card" style="grid-column:1 / -1;">
      <div class="title">Админка</div>
      <div class="muted">Аудит, пользователи, отделы, просмотр ЛС</div>
    </div>

    <div class="card">
      <div class="title">Аудит</div>
      <table id="auditTable">
        <thead>
          <tr><th>time</th><th>actor</th><th>target</th><th>action</th><th>outcome</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <div class="title">Просмотр ЛС</div>
      <div class="row" style="gap:6px; margin-bottom:8px">
        <select id="userA"></select>
        <select id="userB"></select>
        <button id="showDM">Показать</button>
      </div>
      <div id="dm" style="height:260px; overflow:auto; border:1px solid var(--line); border-radius:10px; padding:8px; background:#fff"></div>
    </div>

    <div class="card">
      <div class="title">Пользователи</div>
      <div class="muted" style="margin-bottom:8px">Поиск и обновление ролей/отделов</div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div>
          <input id="q" placeholder="поиск пользователя..." />
          <ul id="users" style="list-style:none; padding:0; margin:8px 0 0 0;"></ul>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px">Обновить выбранного пользователя</div>
          <form id="updateUser" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <input id="updId" placeholder="id" readonly />
            <select id="updRole">
              <option>ADMIN</option>
              <option>HEAD</option>
              <option>EMPLOYEE</option>
            </select>
            <input id="updDisplay" placeholder="displayName" />
            <input id="updDept" placeholder="departmentId (число или пусто)" />
            <div style="grid-column:1 / -1" class="hint">managerId автозаполняется по выбранному departmentId для роли EMPLOYEE</div>
            <input id="updMgr" placeholder="managerId (подставится руководитель отдела)" />
            <button style="grid-column:1 / -1">Сохранить</button>
          </form>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="title">Отделы</div>
      <div class="muted" style="margin-bottom:8px">Список и создание</div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div>
          <table id="deptTable">
            <thead><tr><th>ID</th><th>Название</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div>
          <form id="newDept">
            <input name="name" placeholder="Название отдела" required />
            <button>Создать</button>
          </form>
        </div>
      </div>
    </div>

  </div>

<script>
let usersCache = new Map();
let auditData = [];

function escapeHtml(s){ return (s||'').toString().replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }
function fmtTime(ts){ try{ return new Intl.DateTimeFormat('ru-RU',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit'}).format(new Date(ts)); }catch(_){ return ''; } }
function userLabel(u){ return u?.displayName ? (u.displayName + ' (' + u.username + ')') : (u?.username || ('id '+u?.id)); }
function getUser(id){ return usersCache.get(id) || { id, username: 'id '+id, displayName: 'id '+id }; }

async function loadUsers(){
  const r = await fetch('/api/users/search?q=');
  const list = await r.json();
  list.forEach(u=>usersCache.set(u.id, u));
  const build = (sel)=>{ sel.innerHTML = list.map(u=>`<option value="${u.id}">${escapeHtml(userLabel(u))}</option>`).join(''); };
  build(document.getElementById('userA'));
  build(document.getElementById('userB'));
}

async function loadAudit(){
  const tbody = document.querySelector('#auditTable tbody');
  const r = await fetch('/api/admin/audit');
  const data = await r.json();
  auditData = data.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
  tbody.innerHTML = auditData.map(row=>{
    const actor = getUser(row.actorId);
    const target = row.targetId != null ? String(row.targetId) : (row.resource || '');
    return `<tr>
      <td>${escapeHtml(fmtTime(row.createdAt))}</td>
      <td>${escapeHtml(userLabel(actor))}</td>
      <td>${escapeHtml(target)}</td>
      <td>${escapeHtml(row.action||'')}</td>
      <td>${escapeHtml(row.outcome||'')}</td>
    </tr>`;
  }).join('');
}

document.getElementById('showDM').onclick = async ()=>{
  const a = document.getElementById('userA').value;
  const b = document.getElementById('userB').value;
  const box = document.getElementById('dm');
  box.innerHTML='';
  const r = await fetch(`/api/admin/dms?a=${a}&b=${b}`);
  const msgs = await r.json();
  box.innerHTML = msgs.map(m=> `<div class="muted">${escapeHtml(fmtTime(m.createdAt))} · ${escapeHtml(userLabel(getUser(m.senderId)))}</div><div>${escapeHtml(m.content||'')}</div>`).join('') || '<div class="muted">Пусто</div>';
};

async function loadDepartments(){
  const r = await fetch('/api/departments');
  const rows = await r.json();
  document.querySelector('#deptTable tbody').innerHTML = rows.map(d=> `<tr><td>${d.id}</td><td>${escapeHtml(d.name)}</td></tr>`).join('');
}

document.getElementById('newDept').onsubmit = async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const r = await fetch('/api/departments',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name: fd.get('name') }) });
  if (r.ok){ await loadDepartments(); alert('Отдел создан'); } else { alert('Ошибка'); }
};

document.getElementById('q').oninput = async ()=>{
  const q = document.getElementById('q').value;
  const ul = document.getElementById('users');
  const r = await fetch('/api/users/search?q=' + encodeURIComponent(q));
  const list = await r.json();
  list.forEach(u=>usersCache.set(u.id, u));
  ul.innerHTML = list.map(u=> `<li><button data-id="${u.id}" style="width:100%; text-align:left; border:1px solid var(--line); background:#fff; padding:8px 10px; border-radius:10px; cursor:pointer; margin-bottom:6px;">
    ${escapeHtml(userLabel(u))} · <span class="muted">${escapeHtml(u.role || '')}${u.departmentId?(', dept '+u.departmentId):''}</span>
  </button></li>`).join('');
  ul.querySelectorAll('button').forEach(b=> b.onclick = ()=> fillUpdateForm(+b.dataset.id));
};

function fillUpdateForm(id){
  const u = usersCache.get(id);
  if (!u) return;
  document.getElementById('updId').value = String(u.id);
  document.getElementById('updDisplay').value = u.displayName || '';
  document.getElementById('updRole').value = u.role || 'EMPLOYEE';
  document.getElementById('updDept').value = u.departmentId != null ? String(u.departmentId) : '';
  // Автоподстановка managerId при первичном заполнении формы
  autoFillManager();
  // Если у пользователя уже есть managerId - не мешаем явному значению
  if (u.managerId != null) document.getElementById('updMgr').value = String(u.managerId);
}

function findDeptHead(deptId){
  if (deptId == null) return null;
  for (const u of usersCache.values()) {
    if ((u.role === 'HEAD' || u.role === 'head') && u.departmentId === deptId) return u;
  }
  return null;
}

// Автозаполнение managerId по выбранному departmentId
function autoFillManager(){
  const role = document.getElementById('updRole').value;
  const deptRaw = document.getElementById('updDept').value.trim();
  const deptId = deptRaw ? Number(deptRaw) : null;
  const mgrInput = document.getElementById('updMgr');

  if (role === 'EMPLOYEE' && deptId != null && !Number.isNaN(deptId)) {
    const head = findDeptHead(deptId);
    if (head) {
      mgrInput.value = String(head.id);
      mgrInput.dataset.autofilled = '1';
      mgrInput.title = 'Автоподставлено: ' + (head.displayName || head.username);
    } else {
      if (mgrInput.dataset.autofilled === '1') mgrInput.value = '';
      mgrInput.dataset.autofilled = '';
      mgrInput.title = 'Руководитель отдела не найден';
    }
  } else {
    if (mgrInput.dataset.autofilled === '1') mgrInput.value = '';
    mgrInput.dataset.autofilled = '';
    mgrInput.title = '';
  }
}

document.getElementById('updDept').addEventListener('input', autoFillManager);
document.getElementById('updRole').addEventListener('change', autoFillManager);

document.getElementById('updateUser').onsubmit = async (e)=>{
  e.preventDefault();
  const id = document.getElementById('updId').value;
  if (!id) return alert('Сначала выбери пользователя');
  const payload = {
    displayName: document.getElementById('updDisplay').value,
    role: document.getElementById('updRole').value,
    departmentId: document.getElementById('updDept').value ? Number(document.getElementById('updDept').value) : null,
    managerId: document.getElementById('updMgr').value ? Number(document.getElementById('updMgr').value) : null
  };
  const r = await fetch('/api/admin/users/'+id+'?id='+id, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  if (r.ok) { await loadAudit(); document.getElementById('q').dispatchEvent(new Event('input')); alert('Сохранено'); } else { const j=await r.json().catch(()=>({message:'Ошибка'})); alert(j.message||'Ошибка'); }
};

(async function init(){
  await loadUsers();
  await loadAudit();
  await loadDepartments();
  document.getElementById('q').dispatchEvent(new Event('input'));
})();
</script>
</body>
</html>